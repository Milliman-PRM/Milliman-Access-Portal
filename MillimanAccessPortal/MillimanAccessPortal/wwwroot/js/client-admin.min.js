function getClientTree(){$.ajax({type:"GET",url:"ClientAdmin/ClientFamilyList/"}).done(function(n){clientTree=n.ClientTree;populateProfitCenterDropDown(n.AuthorizedProfitCenterList);renderClientTree(n.RelevantClientId)}).fail(function(n){n.status==401?toastr.error("You are not authorized to view any clients"):toaster.error("An error has occurred")})}function populateProfitCenterDropDown(n){$('#ProfitCenterId option:not(option[value = ""])').remove();$.each(n,function(){$("#ProfitCenterId").append($("<option />").val(this.Id).text(this.Name+" ("+this.Code+")"))})}function GetClientDetail(n){removeClientInserts();var t=n.attr("data-client-id").valueOf();if(n.hasClass("selected")&&!n.hasClass("editing"))return clearSelectedClient(),hideClientForm(),!1;$.ajax({type:"GET",url:"ClientAdmin/ClientDetail/"+t,headers:{RequestVerificationToken:$("input[name='__RequestVerificationToken']").val()}}).done(function(t){populateClientDetails(t.ClientEntity);clearSelectedClient();n.addClass("selected");makeFormReadOnly();showClientForm()}).fail(function(n){toastr.warning(n.getResponseHeader("Warning"));hideClientForm()})}function EditClientDetail(n){removeClientInserts();var t=n.attr("data-client-id").valueOf();$.ajax({type:"GET",url:"ClientAdmin/ClientDetail/"+t,headers:{RequestVerificationToken:$("input[name='__RequestVerificationToken']").val()}}).done(function(t){populateClientDetails(t.ClientEntity);clearSelectedClient();n.addClass("selected");n.addClass("editing");makeFormWriteable();$("#client-form #form-buttons-new").hide();$("#client-form #form-buttons-edit").show();$("#undo-changes-button").hide();showClientForm();$("#client-form :input, #client-form select").on("change",function(){$(this).value!=$(this).attr("data-original-value")&&$("#undo-changes-button").show()})}).fail(function(n){toastr.warning(n.getResponseHeader("Warning"));hideClientForm()})}function newClientFormSetup(){removeClientInserts();clearFormData();clearSelectedClient();makeFormWriteable();$("#client-form #form-buttons-edit").hide();$("#client-form #form-buttons-new").show();showClientForm()}function newChildClientFormSetup(n){var i,t;clearFormData();i=n.attr("data-client-id").valueOf();$("#client-form #ParentClientId").val(i);removeClientInserts();clearSelectedClient();t=childNodePlaceholder;t=n.hasClass("col-xs-12")?t.replace(/{{class}}/g,"col-xs-offset-1 col-xs-11"):t.replace(/{{class}}/g,"col-xs-offset-2 col-xs-10");n.parent().after(t);makeFormWriteable();$("#client-form #form-buttons-edit").hide();$("#client-form #form-buttons-new").show();showClientForm()}function removeClientInserts(){$("#client-tree li.client-insert").remove()}function clearFormData(){$("#client-form #AcceptedEmailDomainList")[0].selectize.clear();$("#client-form #AcceptedEmailDomainList")[0].selectize.clearOptions();$("#client-form #AcceptedEmailAddressExceptionList")[0].selectize.clear();$("#client-form #AcceptedEmailAddressExceptionList")[0].selectize.clearOptions();$('#client-form :input:not(input[name="__RequestVerificationToken"]), #client-form select').attr("data-original-value","");$('#client-form :input:not(input[name="__RequestVerificationToken"]), #client-form select').val("")}function clearSelectedClient(){$("#client-tree-list div.selected").removeClass("selected");$("#client-tree-list div.editing").removeClass("editing")}function makeFormReadOnly(){$("#edit-client-icon").show();$("#cancel-edit-client-icon").hide();$("#client-form :input").attr("readonly","readonly");$("#client-form :input, #client-form select").attr("disabled","disabled");$("#client-form #form-buttons-new").hide();$("#client-form #form-buttons-edit").hide();$("#client-form #AcceptedEmailDomainList")[0].selectize.disable();$("#client-form #AcceptedEmailAddressExceptionList")[0].selectize.disable()}function makeFormWriteable(){$("#edit-client-icon").hide();$("#cancel-edit-client-icon").show();$("#client-form :input").removeAttr("readonly");$("#client-form :input, #client-form select").removeAttr("disabled");$("#client-form #AcceptedEmailDomainList")[0].selectize.enable();$("#client-form #AcceptedEmailAddressExceptionList")[0].selectize.enable()}function showClientForm(){var n=50;$("#client-info").show(n,function(){$("#client-form #Id").val()?$("#client-users").show(n):$("#client-users").hide()})}function hideClientForm(){$("#client-info").hide();$("#client-users").hide()}function populateClientDetails(n){$("#client-form :input, #client-form select").removeAttr("data-original-value");$("#client-form #ProfitCenterId option[temporary-profitcenter]").remove();$.each(n,function(t,r){var u=$("#"+t,"#client-info");if(u.is("select"))$("#client-form #"+t+' option[value="'+r+'"]').length==0&&$("#"+t).append($("<option temporary-profitcenter />").val(n.ProfitCenterId).text(n.ProfitCenter.Name+" ("+n.ProfitCenter.ProfitCenterCode+")")),u.val(r).change();else if(u.hasClass("selectize-custom-input")){if(u[0].selectize.clear(),u[0].selectize.clearOptions(),r)for(i=0;i<r.length;i++)u[0].selectize.addOption({value:r[i],text:r[i]}),u[0].selectize.addItem(r[i])}else u.val(r);u.attr("data-original-value",r)})}function renderClientTree(n){$("#client-tree-list").empty();clientTree.forEach(function(n){renderClientNode(n,1);$("#client-tree-list").append('<li class="hr col-xs-12"><\/li>')});$("div.client-admin-card").on("click",function(){GetClientDetail($(this))});$("div.card-button-background-edit").on("click",function(n){EditClientDetail($(this).parents("div[data-client-id]"));n.stopPropagation()});$("div.card-button-background-add").on("click",function(n){newChildClientFormSetup($(this).parents("div[data-client-id]"));n.stopPropagation()});n&&$('[data-client-id="'+n+'"]').click();$("#add-client-icon").length&&$("#client-tree-list").append(clientCard)}function renderClientNode(n,t){var i=clientNodeTemplate,r;switch(t){case 1:i=i.replace(/{{class}}/g,"col-xs-12");break;case 2:i=i.replace(/{{class}}/g,"col-xs-offset-1 col-xs-11");break;default:i=i.replace(/{{class}}/g,"col-xs-offset-2 col-xs-10")}i=i.replace(/{{header-level}}/g,t+1);i=i.replace(/{{id}}/g,n.ClientEntity.Id);i=i.replace(/{{name}}/g,n.ClientEntity.Name);i=n.ClientEntity.ClientCode?i.replace(/{{clientCode}}/g,n.ClientEntity.ClientCode):i.replace(/{{clientCode}}/g,"");i=i.replace(/{{users}}/g,n.AssociatedUserCount);i=i.replace(/{{content}}/g,n.AssociatedContentCount);r=$(i.toString());n.CanManage||($(".icon-container",r).remove(),$(".client-admin-card",r).addClass("disabled"));n.Children.length!=0&&$(".card-button-background-delete",r).remove();t==3&&$(".card-button-background-add",r).remove();$("#client-tree-list").append(r);n.Children.length&&n.Children.forEach(function(n){renderClientNode(n,t+1)})}function deleteClient(n,t,i){n.stopPropagation();bootbox.confirm({title:"Delete "+i+"?",message:"This action can not be undone.  Do you wish to proceed?",className:"screen-center",backdrop:!0,onEscape:!0,buttons:{confirm:{label:'<i class="fa fa-check"><\/i> Confirm',className:"primary-button btn-danger"},cancel:{label:"Cancel",className:"btn-link"}},callback:function(n){if(n){bootbox.prompt({title:"Please provide your password to proceed with deletion",className:"screen-center",inputType:"password",backdrop:!0,onEscape:!0,buttons:{confirm:{label:'<i class="fa fa-trash"><\/i> DELETE',className:"primary-button btn-danger"},cancel:{label:"Cancel",className:"btn-link"}},callback:function(n){if(n)removeClientNode(t,i,n);else{if(n=="")return toastr.warning("Please enter a password"),!1;toastr.warning("Deletion was canceled")}}});$(".bootbox-input-password").on("keyup",function(n){n.which===13&&$('button[data-bb-handler="confirm"]').trigger("click")})}}})}function removeClientNode(n,t,i){$.ajax({type:"DELETE",url:"ClientAdmin/DeleteClient",data:{Id:n,Password:i},headers:{RequestVerificationToken:$("input[name='__RequestVerificationToken']").val()}}).done(function(n){clientTree=n.ClientTree;renderClientTree(n.RelevantClientId);toastr.success(t+" was successfully deleted.")}).fail(function(n){toastr.warning(n.getResponseHeader("Warning"))})}function searchClientTree(n){var n=n.toUpperCase(),t=document.getElementById("client-tree-list").getElementsByTagName("li"),r=0,u,f;for(i=0;i<t.length;i++)t[i].getElementsByClassName("client-admin-card-title").length>0?(u=t[i].getElementsByClassName("client-admin-card-title")[0],f=t[i].getElementsByClassName("client-admin-card-clientcode")[0],(u||f)&&(u.innerHTML.toUpperCase().indexOf(n)>-1||f.innerHTML.toUpperCase().indexOf(n)>-1?(t[i].style.display="",r=1):t[i].style.display="none")):(t[i].style.display=r==0?"none":"",r=0)}function submitClientForm(n){n.preventDefault();var e=$("#client-form"),u=$("#client-form #Id").val(),f=$("#client-form #Name").val(),t="ClientAdmin/",i,r;u?(t+="EditClient",i=f+" was successfully updated",r="Could not update client information"):(t+="SaveNewClient",i=f+" was successfully created",r="Could not create client");$.ajax({type:"POST",url:t,data:e.serialize(),headers:{RequestVerificationToken:$("input[name='__RequestVerificationToken']").val()}}).done(function(n){hideClientForm();clearFormData();clientTree=n.ClientTree;renderClientTree(n.RelevantClientId);toastr.success(i);$('div.client-admin-card[data-client-id="'+u+'"]').click()}).fail(function(){toastr.warning(r)})}function resetNewClientForm(){event.preventDefault();$('#client-form :input:not(input[name="__RequestVerificationToken"], input[type="hidden"]), #client-form select').each(function(){if($(this).val()!="")return bootbox.confirm({title:"Discard changes?",message:"Would you like to discard the unsaved changes?",className:"screen-center",backdrop:!0,onEscape:!0,buttons:{confirm:{label:'<i class="fa fa-check"><\/i> Confirm',className:"primary-button"},cancel:{label:"Cancel",className:"btn-link"}},callback:function(n){if(n)$("#client-form .input-validation-error").removeClass("input-validation-error"),$("#client-form span.field-validation-error > span").remove(),clearFormData();else return!1}}),!1})}function undoChangesEditClientForm(n){n.preventDefault();var t=$("#client-form #Id").val();bootbox.confirm({title:"Discard changes?",message:"Would you like to discard the unsaved changes?",className:"screen-center",backdrop:!0,onEscape:!0,buttons:{confirm:{label:'<i class="fa fa-check"><\/i> Confirm',className:"primary-button"},cancel:{label:"Cancel",className:"btn-link"}},callback:function(n){n&&EditClientDetail($('#client-tree div[data-client-id="'+t+'"]'))}})}function toggleEditExistingClient(){EditClientDetail($("div.selected"))}function cancelClientEdit(){var n=$("#client-form #Id").val();pendingChanges()?bootbox.confirm({title:"Discard changes?",message:"Would you like to discard the unsaved changes?",className:"screen-center",backdrop:!0,onEscape:!0,buttons:{confirm:{label:'<i class="fa fa-check"><\/i> Confirm',className:"primary-button"},cancel:{label:"Cancel",className:"btn-link"}},callback:function(t){t&&cancelEditTasks(n)}}):cancelEditTasks(n)}function pendingChanges(){var n=$('#client-form input:not(input[name="__RequestVerificationToken"], input[type="hidden"]), #client-form select');for(i=0;i<n.length;i++)if($(n[i]).val()!=$(n[i]).attr("data-original-value"))return!0;return!1}function resetFormValues(){var n=$('#client-form input:not(input[name="__RequestVerificationToken"], input[type="hidden"]), #client-form select');for(i=0;i<n.length;i++)$(n[i]).val($(n[i]).attr("data-original-value"))}function cancelEditTasks(n){resetFormValues();makeFormReadOnly();n||(removeClientInserts(),clearFormData(),hideClientForm())}var clientNodeTemplate=$('script[data-template="clientNode"]').html(),childNodePlaceholder=$('script[data-template="childNodePlaceholder"]').html(),clientCard=$('script[data-template="createNewClientCard"]').html(),clientTree;