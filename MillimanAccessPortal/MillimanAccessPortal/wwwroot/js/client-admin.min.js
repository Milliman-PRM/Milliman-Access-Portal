function getClientTree(){$.ajax({type:"GET",url:"ClientAdmin/ClientFamilyList/"}).done(function(n){clientTree=n.ClientTree;populateProfitCenterDropDown(n.AuthorizedProfitCenterList);renderClientTree(n.RelevantClientId)}).fail(function(n){n.getResponseHeader("Warning")?toastr.warning(n.getResponseHeader("Warning")):toaster.error("An error has occurred")})}function populateProfitCenterDropDown(n){$('#ProfitCenterId option:not(option[value = ""])').remove();$.each(n,function(){$("#ProfitCenterId").append($("<option />").val(this.Id).text(this.Name+" ("+this.Code+")"))})}function GetClientDetail(n){removeClientInserts();var t=n.attr("data-client-id").valueOf();if(n.is("[selected]")&&!n.is("[editing]"))return clearSelectedClient(),hideClientForm(),!1;$.ajax({type:"GET",url:"ClientAdmin/ClientDetail/"+t,headers:{RequestVerificationToken:$("input[name='__RequestVerificationToken']").val()}}).done(function(t){clearValidationErrors();populateClientDetails(t.ClientEntity);renderUserList(t);clearSelectedClient();n.attr("selected","");makeFormReadOnly();n.is("[disabled]")&&$("#client-info #edit-client-icon").hide();showClientForm()}).fail(function(n){toastr.warning(n.getResponseHeader("Warning"));hideClientForm()})}function EditClientDetail(n){removeClientInserts();clearValidationErrors();var t=n.attr("data-client-id").valueOf();$.ajax({type:"GET",url:"ClientAdmin/ClientDetail/"+t,headers:{RequestVerificationToken:$("input[name='__RequestVerificationToken']").val()}}).done(function(t){populateClientDetails(t.ClientEntity);clearSelectedClient();n.attr("selected","");n.attr("editing","");makeFormWriteable();$("#client-form #form-buttons-new").hide();$("#client-form #form-buttons-edit").show();$("#undo-changes-button").hide();showClientForm();$("#client-form :input, #client-form select").on("change",function(){$(this).value!=$(this).attr("data-original-value")&&$("#undo-changes-button").show()})}).fail(function(n){toastr.warning(n.getResponseHeader("Warning"));hideClientForm()})}function newClientFormSetup(){removeClientInserts();clearFormData();clearSelectedClient();makeFormWriteable();$("#client-tree #create-new-client-card").attr("selected","");$("#client-form #form-buttons-edit").hide();$("#client-form #form-buttons-new").show();showClientForm()}function newChildClientFormSetup(n){var i,t;clearFormData();i=n.attr("data-client-id").valueOf();$("#client-form #ParentClientId").val(i);removeClientInserts();clearSelectedClient();t=childNodePlaceholder;t=n.hasClass("card-100")?t.replace(/{{class}}/g,"card-90"):t.replace(/{{class}}/g,"card-80");n.parent().after(t);makeFormWriteable();$("#client-form #form-buttons-edit").hide();$("#client-form #form-buttons-new").show();showClientForm()}function removeClientInserts(){$("#client-tree li.client-insert").remove()}function clearFormData(){$("#client-form #AcceptedEmailDomainList")[0].selectize.clear();$("#client-form #AcceptedEmailDomainList")[0].selectize.clearOptions();$("#client-form #AcceptedEmailAddressExceptionList")[0].selectize.clear();$("#client-form #AcceptedEmailAddressExceptionList")[0].selectize.clearOptions();$('#client-form :input:not(input[name="__RequestVerificationToken"]), #client-form select').attr("data-original-value","");$('#client-form :input:not(input[name="__RequestVerificationToken"]), #client-form select').val("");clearValidationErrors()}function clearValidationErrors(){$("#client-form .input-validation-error").removeClass("input-validation-error");$("#client-form span.field-validation-error > span").remove()}function clearSelectedClient(){$("#client-tree-list div[selected]").removeAttr("selected");$("#client-tree-list div[editing]").removeAttr("editing")}function makeFormReadOnly(){$("#edit-client-icon").show();$("#cancel-edit-client-icon").hide();$("#client-form :input").attr("readonly","readonly");$("#client-form :input, #client-form select").attr("disabled","disabled");$("#client-form #form-buttons-new").hide();$("#client-form #form-buttons-edit").hide();$("#client-form #AcceptedEmailDomainList")[0].selectize.disable();$("#client-form #AcceptedEmailAddressExceptionList")[0].selectize.disable()}function makeFormWriteable(){$("#edit-client-icon").hide();$("#cancel-edit-client-icon").show();$("#client-form :input").removeAttr("readonly");$("#client-form :input, #client-form select").removeAttr("disabled");$("#client-form #AcceptedEmailDomainList")[0].selectize.enable();$("#client-form #AcceptedEmailAddressExceptionList")[0].selectize.enable()}function showClientForm(){var n=50;$("#client-info").show(n,function(){$("#client-form #Name").focus();$("#client-form #Id").val()?$("#client-users").show(n):$("#client-users").hide()})}function hideClientForm(){$("#client-info").hide();$("#client-users").hide()}function populateClientDetails(n){$("#client-form :input, #client-form select").removeAttr("data-original-value");$("#client-form #ProfitCenterId option[temporary-profitcenter]").remove();$.each(n,function(t,r){var u=$("#"+t,"#client-info");if(u.is("select"))$("#client-form #"+t+' option[value="'+r+'"]').length==0&&$("#"+t).append($("<option temporary-profitcenter />").val(n.ProfitCenterId).text(n.ProfitCenter.Name+" ("+n.ProfitCenter.ProfitCenterCode+")")),u.val(r).change();else if(u.hasClass("selectize-custom-input")){if(u[0].selectize.clear(),u[0].selectize.clearOptions(),r)for(i=0;i<r.length;i++)u[0].selectize.addOption({value:r[i],text:r[i]}),u[0].selectize.addItem(r[i])}else u.val(r);u.attr("data-original-value",r)})}function renderClientTree(n){$("#client-tree-list").empty();clientTree.forEach(function(n){renderClientNode(n,1);$("#client-tree-list").append('<li class="hr width-100pct"><\/li>')});$("#client-tree-list div.card-container").on("click",function(){GetClientDetail($(this))});$("div.card-button-edit").on("click",function(n){EditClientDetail($(this).parents("div[data-client-id]"));n.stopPropagation()});$("div.card-button-new-child").on("click",function(n){newChildClientFormSetup($(this).parents("div[data-client-id]"));n.stopPropagation()});n&&$('[data-client-id="'+n+'"]').click();$("#add-client-icon").length&&$("#client-tree-list").append(clientCard)}function renderClientNode(n,t){var i=clientNodeTemplate,r;switch(t){case 1:i=i.replace(/{{class}}/g,"card-100");break;case 2:i=i.replace(/{{class}}/g,"card-90");break;default:i=i.replace(/{{class}}/g,"card-80")}i=i.replace(/{{header-level}}/g,t+1);i=i.replace(/{{id}}/g,n.ClientEntity.Id);i=i.replace(/{{name}}/g,n.ClientEntity.Name);i=n.ClientEntity.ClientCode?i.replace(/{{clientCode}}/g,n.ClientEntity.ClientCode):i.replace(/{{clientCode}}/g,"");i=i.replace(/{{users}}/g,n.AssociatedUserCount);i=i.replace(/{{content}}/g,n.AssociatedContentCount);r=$(i.toString());n.CanManage||($(".icon-container",r).remove(),$(".client-admin-card",r).attr("disabled",""));n.Children.length!=0&&$(".card-button-background-delete",r).remove();t==3&&$(".card-button-background-add",r).remove();$("#client-tree-list").append(r);n.Children.length&&n.Children.forEach(function(n){renderClientNode(n,t+1)})}function deleteClient(n,t,i){n.stopPropagation();vex.dialog.confirm({unsafeMessage:"<h3>Delete "+i+"?<\/h3><p>This action can not be undone.  Do you wish to proceed?<\/p>",buttons:[$.extend({},vex.dialog.buttons.YES,{text:"Confirm",className:"red-button"}),$.extend({},vex.dialog.buttons.NO,{text:"Cancel",className:"link-button"})],callback:function(n){n?vex.dialog.prompt({message:"Please provide your password to proceed with deletion",input:'<input name="password" type="password" placeholder="Password" required />',buttons:[$.extend({},vex.dialog.buttons.YES,{text:"DELETE",className:"red-button"}),$.extend({},vex.dialog.buttons.NO,{text:"Cancel",className:"link-button"})],callback:function(n){if(n)removeClientNode(t,i,n);else{if(n=="")return toastr.warning("Please enter your password to proceed"),!1;toastr.info("Deletion was canceled")}}}):toastr.info("Deletion was canceled")}})}function removeClientNode(n,t,i){$.ajax({type:"DELETE",url:"ClientAdmin/DeleteClient",data:{Id:n,Password:i},headers:{RequestVerificationToken:$("input[name='__RequestVerificationToken']").val()}}).done(function(n){clientTree=n.ClientTree;renderClientTree(n.RelevantClientId);clearFormData();hideClientForm();toastr.success(t+" was successfully deleted.")}).fail(function(n){toastr.warning(n.getResponseHeader("Warning"))})}function searchClientTree(n){var n=n.toUpperCase(),t=document.getElementById("client-tree-list").getElementsByTagName("li"),r=0,u,f;for(i=0;i<t.length;i++)t[i].getElementsByClassName("client-admin-card-title").length>0?(u=t[i].getElementsByClassName("client-admin-card-title")[0],f=t[i].getElementsByClassName("client-admin-card-clientcode")[0],(u||f)&&(u.innerHTML.toUpperCase().indexOf(n)>-1||f.innerHTML.toUpperCase().indexOf(n)>-1?(t[i].style.display="",r=1):t[i].style.display="none")):(t[i].style.display=r==0?"none":"",r=0)}function submitClientForm(n){if($("#client-form").valid()){n.preventDefault();var f=$("#client-form"),r=$("#client-form #Id").val(),u=$("#client-form #Name").val(),t="ClientAdmin/",i;r?(t+="EditClient",i=u+" was successfully updated"):(t+="SaveNewClient",i=u+" was successfully created");$.ajax({type:"POST",url:t,data:f.serialize(),headers:{RequestVerificationToken:$("input[name='__RequestVerificationToken']").val()}}).done(function(n){hideClientForm();clearFormData();clientTree=n.ClientTree;renderClientTree(n.RelevantClientId);toastr.success(i);$('div.client-admin-card[data-client-id="'+r+'"]').click()}).fail(function(n){toastr.warning(n.getResponseHeader("Warning"))})}}function resetNewClientForm(){event.preventDefault();clearValidationErrors();$('#client-form :input:not(input[name="__RequestVerificationToken"], input[type="hidden"]), #client-form select').each(function(){if($(this).val()!="")return vex.dialog.confirm({message:"Would you like to discard the unsaved changes?",buttons:[$.extend({},vex.dialog.buttons.YES,{text:"Confirm",className:"green-button"}),$.extend({},vex.dialog.buttons.NO,{text:"Cancel",className:"link-button"})],callback:function(n){if(n)$("#client-form .input-validation-error").removeClass("input-validation-error"),$("#client-form span.field-validation-error > span").remove(),clearFormData();else return!1}}),!1})}function undoChangesEditClientForm(n){n.preventDefault();clearValidationErrors();var t=$("#client-form #Id").val();vex.dialog.confirm({message:"Would you like to discard the unsaved changes?",buttons:[$.extend({},vex.dialog.buttons.YES,{text:"Confirm",className:"green-button"}),$.extend({},vex.dialog.buttons.NO,{text:"Cancel",className:"link-button"})],callback:function(n){n&&EditClientDetail($('#client-tree div[data-client-id="'+t+'"]'))}})}function toggleEditExistingClient(){EditClientDetail($("div[selected]"))}function cancelClientEdit(){var n=$("#client-form #Id").val();pendingChanges()?vex.dialog.confirm({message:"Would you like to discard the unsaved changes?",buttons:[$.extend({},vex.dialog.buttons.YES,{text:"Confirm",className:"green-button"}),$.extend({},vex.dialog.buttons.NO,{text:"Cancel",className:"link-button"})],callback:function(t){t&&cancelEditTasks(n)}}):cancelEditTasks(n)}function pendingChanges(){var n=$('#client-form input:not(input[name="__RequestVerificationToken"], input[type="hidden"]), #client-form select');for(i=0;i<n.length;i++)if($(n[i]).val()!=$(n[i]).attr("data-original-value"))return!0;return!1}function resetFormValues(){var n=$('#client-form input:not(input[name="__RequestVerificationToken"], input[type="hidden"]), #client-form select');for(i=0;i<n.length;i++)$(n[i]).val($(n[i]).attr("data-original-value"))}function cancelEditTasks(n){resetFormValues();makeFormReadOnly();n||(removeClientInserts(),clearFormData(),hideClientForm(),clearSelectedClient())}function renderUserList(n,t){$("#client-user-list").empty();n.AssignedUsers.forEach(function(t){renderUserNode(n.ClientEntity.Id,t)});$("div.card-button-remove-user").on("click",function(n){n.stopPropagation()});$("div[data-client-id][data-user-id]").on("click",function(n){$(this).find("div.card-expansion-container").is("[maximized]")?$(this).find("div.card-expansion-container").removeAttr("maximized"):$(this).find("div.card-expansion-container").attr("maximized","");toggleExpandCollapse();n.stopPropagation()});toggleExpandCollapse();n.EligibleUsers&&console.log(n.EligibleUsers);t&&$('[data-user-id="'+t+'"]').click()}function renderUserNode(n,t){var i=userNodeTemplate,r;i=i.replace(/{{clientId}}/g,n);i=i.replace(/{{id}}/g,t.Id);i=i.replace(/{{name}}/g,t.FirstName+" "+t.LastName);i=i.replace(/{{username}}/g,t.UserName);t.UserName!=t.Email&&(i=i.replace(/{{email}}/g,t.Email));r=$(i.toString());$("div.card-container[data-search-string]",r).attr("data-search-string",t.FirstName.toUpperCase()+" "+t.LastName.toUpperCase()+"|"+t.UserName.toUpperCase()+"|"+t.Email.toUpperCase());$('.card-body-secondary-text:contains("{{email}}")',r).remove();$("#client-user-list").append(r)}function expandAllUsers(){$("#client-user-list div.card-expansion-container").attr("maximized","");toggleExpandCollapse()}function collapseAllUsers(){$("#client-user-list div.card-expansion-container[maximized]").removeAttr("maximized");toggleExpandCollapse()}function toggleExpandCollapse(){$("div.card-expansion-container:not([maximized])").length>0?$("#expand-user-icon").show():$("#expand-user-icon").hide();$("div.card-expansion-container[maximized]").length>0?$("#collapse-user-icon").show():$("#collapse-user-icon").hide()}function searchUser(n){var n=n.toUpperCase(),t=$("#client-user-list div[data-search-string]");for(i=0;i<t.length;i++)t[i].style.display=$(t[i]).attr("data-search-string").indexOf(n)>-1?"":"none"}var clientNodeTemplate=$('script[data-template="clientNode"]').html(),childNodePlaceholder=$('script[data-template="childNodePlaceholder"]').html(),clientCard=$('script[data-template="createNewClientCard"]').html(),userNodeTemplate=$('script[data-template="userNode"]').html(),clientTree;